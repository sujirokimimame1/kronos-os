<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kronos - √Årea do T√©cnico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4FC3F7;
            --primary-dark: #29B6F6;
            --primary-light: #81D4FA;
            --primary-glow: rgba(79, 195, 247, 0.35);
            --secondary: #BA68C8;
            --secondary-glow: rgba(186, 104, 200, 0.25);
            
            --black: #0F172A;
            --black-light: #1E293B;
            --black-lighter: #334155;
            --light: #FFFFFF;
            --gray: #94A3B8;
            --card-bg: rgba(15, 23, 42, 0.65);
            --card-border: rgba(79, 195, 247, 0.2);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --glow: 0 0 12px var(--primary-glow), 0 0 20px var(--primary-glow);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--black) 0%, var(--black-light) 50%, var(--black-lighter) 100%);
            color: var(--light);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 85%, var(--primary-glow) 0%, transparent 60%),
                radial-gradient(circle at 85% 15%, var(--secondary-glow) 0%, transparent 60%),
                radial-gradient(circle at 50% 40%, rgba(186, 104, 200, 0.08) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .header:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow), 0 0 20px var(--primary-glow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cross-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cross-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 20px var(--primary-glow);
            animation: neonPulse 3s infinite;
        }

        .cross {
            position: relative;
            width: 25px;
            height: 25px;
        }

        .cross::before,
        .cross::after {
            content: '';
            position: absolute;
            background: var(--black);
            border-radius: 2px;
        }

        .cross::before {
            width: 25px;
            height: 5px;
            top: 10px;
            left: 0;
        }

        .cross::after {
            width: 5px;
            height: 25px;
            top: 0;
            left: 10px;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            color: var(--black);
            border: 1px solid rgba(79, 195, 247, 0.35);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.2);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: -1;
            opacity: 0.95;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--primary-glow), 0 0 25px rgba(79, 195, 247, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--card-border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: rgba(79, 195, 247, 0.1);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .btn-warning {
            background: transparent;
            color: #FFD93D;
            border: 1px solid rgba(255, 217, 61, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 217, 61, 0.1);
            box-shadow: 0 0 10px rgba(255, 217, 61, 0.4);
        }

        .btn-info {
            background: transparent;
            color: #4DABF7;
            border: 1px solid rgba(77, 171, 247, 0.3);
        }

        .btn-info:hover {
            background: rgba(77, 171, 247, 0.1);
            box-shadow: 0 0 10px rgba(77, 171, 247, 0.4);
        }

        /* ‚úÖ ESTILOS PARA NOTIFICA√á√ïES */
        .notification-badge {
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: none;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -5px;
            right: -5px;
            animation: pulse 1.5s infinite;
        }

        .btn-notification {
            position: relative;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ‚úÖ Efeito para novas OS */
        .os-item.nova-os {
            animation: highlight 2s ease;
            border-left: 4px solid #FFD93D;
        }

        @keyframes highlight {
            0% { background: rgba(255, 217, 61, 0.3); }
            100% { background: rgba(15, 23, 42, 0.4); }
        }

        /* Welcome Section */
        .dashboard-header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            animation: fadeInUp 0.6s ease;
        }

        .dashboard-header h2 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
            text-shadow: 0 0 5px var(--primary-glow);
        }

        .dashboard-header p {
            color: var(--gray);
        }

        /* ‚úÖ NOVOS ESTILOS PARA FILTROS */
        .filters-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filters-header h3 {
            color: var(--primary);
            font-size: 1.3rem;
            text-shadow: 0 0 5px var(--primary-glow);
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.4);
            color: var(--light);
            border: 1px solid var(--card-border);
            font-size: 0.9rem;
            min-width: 150px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .quick-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .quick-filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--card-border);
            background: transparent;
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .quick-filter-btn:hover,
        .quick-filter-btn.active {
            background: var(--primary);
            color: var(--black);
            border-color: var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow), 0 0 20px var(--primary-glow);
        }

        .stat-card.active {
            border-color: var(--primary);
            box-shadow: var(--shadow), 0 0 20px var(--primary-glow);
        }

        .stat-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .stat-total { color: var(--primary); }
        .stat-abertas { color: #FF6B6B; }
        .stat-andamento { color: #FFD93D; }
        .stat-aguardando { color: #9b59b6; }
        .stat-finalizadas { color: var(--primary); }
        .stat-canceladas { color: #6C757D; }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }

        /* ‚úÖ NOVOS ESTILOS PARA ABAS DE STATUS */
        .status-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid var(--card-border);
        }

        .status-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--card-border);
            background: transparent;
            color: var(--gray);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .status-tab:hover {
            border-color: var(--primary);
            background: rgba(79, 195, 247, 0.1);
        }

        .status-tab.active {
            background: var(--primary);
            color: var(--black);
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .status-tab-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* OS Sections */
        .os-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .os-sections {
                grid-template-columns: 1fr;
            }
        }

        .os-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            animation: fadeIn 0.6s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(79, 195, 247, 0.2);
        }

        .section-header h3 {
            color: var(--primary);
            font-size: 1.3rem;
            text-shadow: 0 0 5px var(--primary-glow);
        }

        .section-count {
            background: rgba(79, 195, 247, 0.15);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .os-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .os-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }

        .os-item:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
            transform: translateY(-2px);
        }

        .os-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .os-info h4 {
            color: var(--light);
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .os-meta {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-aberto { 
            background: rgba(255, 107, 107, 0.2); 
            color: #FF6B6B;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .status-andamento { 
            background: rgba(255, 217, 61, 0.2); 
            color: #FFD93D;
            border: 1px solid rgba(255, 217, 61, 0.3);
        }
        .status-aguardandopecas { 
            background: rgba(155, 89, 182, 0.2); 
            color: #9b59b6;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        .status-finalizado { 
            background: rgba(79, 195, 247, 0.2); 
            color: var(--primary);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        .status-cancelado { 
            background: rgba(108, 117, 125, 0.2); 
            color: #6C757D;
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        .os-details {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .os-details p {
            margin-bottom: 0.5rem;
        }

        .os-details strong {
            color: var(--light);
        }

        .os-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            position: relative;
            overflow: hidden;
        }

        .btn-andamento { 
            background: transparent;
            color: #FFD93D;
            border: 1px solid rgba(255, 217, 61, 0.3);
        }
        .btn-aguardando { 
            background: transparent;
            color: #9b59b6;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        .btn-finalizar { 
            background: transparent;
            color: var(--primary);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        .btn-cancelar { 
            background: transparent;
            color: #FF6B6B;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .btn-detalhes { 
            background: transparent;
            color: #4DABF7;
            border: 1px solid rgba(77, 171, 247, 0.3);
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 8px currentColor;
        }

        /* ‚úÖ ESTILOS PARA PRIORIDADES */
        .prioridade-badge {
            padding: 0.3rem 0.7rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .prioridade-baixa {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .prioridade-media {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }

        .prioridade-alta {
            background: rgba(230, 126, 34, 0.2);
            color: #e67e22;
            border: 1px solid rgba(230, 126, 34, 0.3);
        }

        .prioridade-critica {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
            animation: pulse 2s infinite;
        }

        /* ‚úÖ Destaque para OS com prioridade alterada */
        .os-item.prioridade-reclassificada {
            border-left: 4px solid #FFD93D;
            background: rgba(255, 217, 61, 0.05);
        }

        /* ‚úÖ ESTILOS PARA BOT√ïES VER MAIS */
        .ver-mais-container {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(79, 195, 247, 0.2);
        }

        .btn-ver-mais {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--card-border);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(12px);
        }

        .btn-ver-mais:hover {
            border-color: var(--primary);
            background: rgba(79, 195, 247, 0.1);
            box-shadow: 0 0 10px var(--primary-glow);
            transform: translateY(-2px);
        }

        .btn-ver-mais:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ‚úÖ Indicador de carregamento */
        .loading-more {
            text-align: center;
            padding: 1rem;
            color: var(--gray);
        }

        .loading-more i {
            margin-right: 0.5rem;
        }

        /* Loading States */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 16px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            margin: 1rem 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow), var(--glow);
            position: relative;
        }

        .close {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 1rem;
            top: 1rem;
            z-index: 10;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-size: 0.95rem;
            font-weight: 600;
            text-shadow: 0 0 4px var(--primary-glow);
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.4);
            color: var(--light);
            border: 1px solid var(--card-border);
            font-size: 1rem;
            transition: all 0.35s ease;
            backdrop-filter: blur(8px);
        }

        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            background: rgba(15, 23, 42, 0.6);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn-submit {
            width: 100%;
            padding: 1.25rem;
            background: transparent;
            color: var(--black);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1rem;
            transition: all 0.35s ease;
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(79, 195, 247, 0.35);
            position: relative;
            overflow: hidden;
        }

        .btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 16px;
            z-index: -1;
            opacity: 0.95;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--primary-glow), 0 0 25px rgba(79, 195, 247, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Animations */
        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 20px var(--primary-glow); }
            50% { box-shadow: 0 0 28px var(--primary-glow), 0 0 35px var(--primary-glow); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: rgba(46, 204, 113, 0.95);
            border: 1px solid rgba(46, 204, 113, 0.5);
        }

        .toast.error {
            background: rgba(231, 76, 60, 0.95);
            border: 1px solid rgba(231, 76, 60, 0.5);
        }

        .toast.warning {
            background: rgba(241, 196, 15, 0.95);
            border: 1px solid rgba(241, 196, 15, 0.5);
        }

        .toast.info {
            background: rgba(52, 152, 219, 0.95);
            border: 1px solid rgba(52, 152, 219, 0.5);
        }

        .toast.urgent {
            background: rgba(231, 76, 60, 0.95);
            border: 2px solid #FFD93D;
            animation: pulse 1s infinite;
        }

        /* ‚úÖ NOVOS ESTILOS PARA CONTROLE DE SOM */
        .sound-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sound-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }
        
        .sound-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        
        .sound-btn.active {
            background: var(--primary);
            color: var(--black);
        }
        
        .sound-btn.testing {
            animation: pulse 0.5s infinite;
        }
        
        .sound-status {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--card-border);
            font-size: 0.8rem;
            color: var(--gray);
            max-width: 200px;
            text-align: center;
            display: none;
        }

        /* ‚úÖ ESTILOS PARA MODAL DE DESTRAVAMENTO DE √ÅUDIO */
        .audio-unlock-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .audio-unlock-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            margin: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow), var(--glow);
        }

        .audio-unlock-content h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .audio-unlock-content p {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }

        .audio-unlock-btn {
            background: var(--primary);
            color: var(--black);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .audio-unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--primary-glow);
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .status-tabs {
                flex-direction: column;
            }
            
            .status-tab {
                min-width: auto;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-select {
                min-width: auto;
            }
            
            .os-actions {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 1.5rem;
                width: 95%;
            }

            .toast {
                left: 10px;
                right: 10px;
                top: 10px;
                transform: translateY(-100px);
            }

            .toast.show {
                transform: translateY(0);
            }

            /* Mobile touch improvements */
            .btn, .btn-action {
                min-height: 44px;
                min-width: 44px;
            }

            .os-item {
                padding: 1rem;
            }

            .section-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .section-count {
                align-self: flex-end;
            }
            
            /* Ajustes para controles de som no mobile */
            .sound-controls {
                bottom: 10px;
                right: 10px;
            }
            
            .sound-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .sound-status {
                bottom: 70px;
                right: 10px;
                font-size: 0.7rem;
            }

            .audio-unlock-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .logo-text h1 {
                font-size: 1.5rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .os-sections {
                gap: 1rem;
            }
        }

        /* Prevent zoom on input focus for mobile */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toastContainer"></div>

    <!-- ‚úÖ MODAL PARA DESTRAVAMENTO DE √ÅUDIO - CORRIGIDO PARA MOBILE -->
    <div id="audioUnlockModal" class="audio-unlock-modal">
        <div class="audio-unlock-content">
            <h3>üîä Ativar Som</h3>
            <p>Para receber notifica√ß√µes sonoras de novas OS, clique no bot√£o abaixo para ativar o √°udio.</p>
            <p style="font-size: 0.9rem; color: var(--primary-light); margin-bottom: 1rem;">
                <i class="fas fa-info-circle"></i> Necess√°rio devido √†s pol√≠ticas dos navegadores
            </p>
            <button class="audio-unlock-btn" onclick="destravarAudioInterativo()">
                <i class="fas fa-volume-up"></i> Ativar Som
            </button>
        </div>
    </div>
    
    <!-- ‚úÖ CONTROLES DE SOM FIXOS -->
    <div class="sound-controls">
        <button class="sound-btn" id="btnToggleSound" title="Ativar/Desativar Som">
            <i class="fas fa-volume-mute"></i>
        </button>
        <button class="sound-btn" id="btnTestSound" title="Testar Som">
            <i class="fas fa-music"></i>
        </button>
    </div>
    
    <div class="sound-status" id="soundStatus"></div>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <div class="cross-container">
                        <div class="cross-circle">
                            <div class="cross"></div>
                        </div>
                    </div>
                </div>
                <div class="logo-text">
                    <h1>Kronos OS - T√©cnico</h1>
                </div>
            </div>
            <div class="header-actions">
                <span id="userInfo" style="color: var(--gray);"></span>
                
                <!-- ‚úÖ BOT√ÉO DE NOTIFICA√á√ïES -->
                <button class="btn btn-info btn-notification" id="btnNotificacoes" onclick="alternarNotificacoes()">
                    <i class="fas fa-bell"></i> Notifica√ß√µes
                    <span class="notification-badge" id="contadorNovasOS">0</span>
                </button>
                
                <button class="btn btn-warning" onclick="trocarSetor()">
                    <i class="fas fa-sync-alt"></i> Trocar Setor
                </button>
                <button class="btn btn-info" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i> Relat√≥rios
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </header>

        <!-- Welcome Section -->
        <div class="dashboard-header fade-in">
            <h2 id="welcomeMessage">Bem-vindo, T√©cnico!</h2>
            <p>Gerencie as ordens de servi√ßo do seu setor</p>
        </div>

        <!-- ‚úÖ NOVO: FILTROS AVAN√áADOS -->
        <div class="filters-container fade-in">
            <div class="filters-header">
                <h3><i class="fas fa-filter"></i> Filtros e Pesquisa</h3>
                <button class="btn btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-times"></i> Limpar Filtros
                </button>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label><i class="fas fa-calendar"></i> Per√≠odo:</label>
                    <select class="filter-select" id="filtroPeriodo" onchange="aplicarFiltros()">
                        <option value="todos">Todos os per√≠odos</option>
                        <option value="hoje">Hoje</option>
                        <option value="ontem">Ontem</option>
                        <option value="7dias">√öltimos 7 dias</option>
                        <option value="15dias">√öltimos 15 dias</option>
                        <option value="30dias">√öltimos 30 dias</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label><i class="fas fa-sort"></i> Ordenar por:</label>
                    <select class="filter-select" id="filtroOrdenacao" onchange="aplicarFiltros()">
                        <option value="data_recente">Data mais recente</option>
                        <option value="data_antiga">Data mais antiga</option>
                        <option value="prioridade">Prioridade (Alta ‚Üí Baixa)</option>
                        <option value="numero">N√∫mero da OS</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label><i class="fas fa-search"></i> Pesquisar:</label>
                    <input type="text" class="filter-select" id="filtroPesquisa" placeholder="N¬∫ OS, cliente, descri√ß√£o..." oninput="aplicarFiltros()">
                </div>
            </div>
            
            <div class="quick-filters">
                <button class="quick-filter-btn active" onclick="filtrarPorPrioridade('todas')">Todas</button>
                <button class="quick-filter-btn" onclick="filtrarPorPrioridade('critica')">üî¥ Cr√≠tica</button>
                <button class="quick-filter-btn" onclick="filtrarPorPrioridade('alta')">üü† Alta</button>
                <button class="quick-filter-btn" onclick="filtrarPorPrioridade('media')">üü° M√©dia</button>
                <button class="quick-filter-btn" onclick="filtrarPorPrioridade('baixa')">üü¢ Baixa</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="fade-in">
            <h3 style="color: var(--primary); margin-bottom: 1.5rem; text-shadow: 0 0 5px var(--primary-glow);">
                <i class="fas fa-chart-pie"></i> Estat√≠sticas do Setor
            </h3>
            <div class="stats-grid">
                <div class="stat-card active" onclick="filtrarPorStatus('todos')">
                    <div class="stat-number stat-total" id="total-os">0</div>
                    <div class="stat-label">Total de OS</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('aberto')">
                    <div class="stat-number stat-abertas" id="os-abertas">0</div>
                    <div class="stat-label">OSs Abertas</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('andamento')">
                    <div class="stat-number stat-andamento" id="os-andamento">0</div>
                    <div class="stat-label">Em Andamento</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('aguardando')">
                    <div class="stat-number stat-aguardando" id="os-aguardando">0</div>
                    <div class="stat-label">Aguardando Pe√ßas</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('finalizado')">
                    <div class="stat-number stat-finalizadas" id="os-finalizadas">0</div>
                    <div class="stat-label">Finalizadas</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('cancelado')">
                    <div class="stat-number stat-canceladas" id="os-canceladas">0</div>
                    <div class="stat-label">Canceladas</div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ NOVO: ABAS DE STATUS -->
        <div class="status-tabs fade-in">
            <button class="status-tab active" onclick="mudarAba('todos')">
                <i class="fas fa-layer-group"></i> Todas as OS
                <span class="status-tab-badge" id="badge-todos">0</span>
            </button>
            <button class="status-tab" onclick="mudarAba('aberto')">
                <i class="fas fa-clock"></i> Em Aberto
                <span class="status-tab-badge" id="badge-aberto">0</span>
            </button>
            <button class="status-tab" onclick="mudarAba('andamento')">
                <i class="fas fa-play-circle"></i> Em Andamento
                <span class="status-tab-badge" id="badge-andamento">0</span>
            </button>
            <button class="status-tab" onclick="mudarAba('aguardando')">
                <i class="fas fa-pause-circle"></i> Aguardando Pe√ßas
                <span class="status-tab-badge" id="badge-aguardando">0</span>
            </button>
            <button class="status-tab" onclick="mudarAba('finalizado')">
                <i class="fas fa-check-circle"></i> Finalizadas
                <span class="status-tab-badge" id="badge-finalizado">0</span>
            </button>
            <button class="status-tab" onclick="mudarAba('cancelado')">
                <i class="fas fa-times-circle"></i> Canceladas
                <span class="status-tab-badge" id="badge-cancelado">0</span>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <p><i class="fas fa-spinner fa-spin"></i> Carregando ordens de servi√ßo...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error" style="display: none;">
            <p id="errorMessage"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar ordens de servi√ßo</p>
            <button class="btn btn-secondary" onclick="carregarOSsSetor()" style="margin-top: 10px;">
                <i class="fas fa-redo"></i> Tentar Novamente
            </button>
        </div>

        <!-- OS Sections -->
        <div id="contentArea" style="display: none;">
            <div class="os-sections fade-in">
                <!-- ‚úÖ AGORA APENAS UMA SE√á√ÉO DIN√ÇMICA -->
                <div class="os-section">
                    <div class="section-header">
                        <h3 id="sectionTitle"><i class="fas fa-list"></i> Todas as Ordens de Servi√ßo</h3>
                        <span class="section-count" id="count-exibidas">0</span>
                    </div>
                    <div class="os-list" id="listaOS">
                        <!-- Todas as OS ser√£o inseridas aqui dinamicamente -->
                    </div>
                    <!-- ‚úÖ BOT√ÉO VER MAIS -->
                    <div class="ver-mais-container" id="verMaisContainer" style="display: none;">
                        <button class="btn btn-secondary" onclick="carregarMaisOS()" id="btnVerMais">
                            <i class="fas fa-chevron-down"></i> Ver Mais OS
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para atualizar OS -->
    <div id="modalAtualizarOS" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 1.5rem; text-align: center;">
                <i class="fas fa-edit"></i> Atualizar Ordem de Servi√ßo
            </h3>
            <form id="formAtualizarOS">
                <input type="hidden" id="osId">
                
                <div class="form-group">
                    <label><i class="fas fa-flag"></i> Status:</label>
                    <select id="osStatus" required>
                        <option value="Aberto">üü¢ Aberto</option>
                        <option value="Em Andamento">üü° Em Andamento</option>
                        <option value="Aguardando Pe√ßas">üü£ Aguardando Pe√ßas</option>
                        <option value="Finalizado">‚úÖ Finalizado</option>
                        <option value="Cancelado">‚ùå Cancelado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-exclamation-triangle"></i> Reclassificar Prioridade:</label>
                    <select id="osPrioridade">
                        <option value="">Manter prioridade atual</option>
                        <option value="Baixa">üü¢ Baixa</option>
                        <option value="M√©dia">üü° M√©dia</option>
                        <option value="Alta">üü† Alta</option>
                        <option value="Cr√≠tica">üî¥ Cr√≠tica</option>
                    </select>
                    <small style="color: var(--gray); font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Opcional: Corrija a prioridade se necess√°rio
                    </small>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-file-alt"></i> Relat√≥rio T√©cnico:</label>
                    <textarea id="osRelato" placeholder="Descreva a solu√ß√£o aplicada, diagn√≥stico, observa√ß√µes..."></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-tools"></i> Materiais Utilizados:</label>
                    <textarea id="osMateriais" placeholder="Liste os materiais, pe√ßas ou componentes utilizados..."></textarea>
                </div>
                
                <button type="submit" class="btn-submit" id="btnSubmitModal">
                    <i class="fas fa-check-circle"></i> Atualizar OS
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let userSetor = '';
        let currentOSData = null;

        // ‚úÖ CONFIGURA√á√ÉO DO BANCO DE DADOS (PRESERVADA)
        const DB_CONFIG = {
            name: 'KronosOSDB',
            version: 1,
            stores: {
                os: 'id, status, setor_destino, data_abertura, prioridade',
                user: 'id, nome, email, setor',
                config: 'key, value'
            }
        };

        let db = null;

        // ‚úÖ VARI√ÅVEIS GLOBAIS PARA FILTROS (PRESERVADAS)
        let todasOS = [];
        let osFiltradas = [];
        let osVisiveis = 10;
        let filtroAtual = {
            status: 'todos',
            periodo: 'todos',
            ordenacao: 'data_recente',
            pesquisa: '',
            prioridade: 'todas'
        };

        // ‚úÖ SISTEMA DE SOM MODERNO - CORRIGIDO PARA MOBILE
        let audioContext = null;
        let audioEnabled = localStorage.getItem('kronos_audio') !== 'false';
        let audioUnlocked = false;
        let audioTested = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // ‚úÖ SISTEMA DE NOTIFICA√á√ÉO (PRESERVADO)
        let notificationEnabled = localStorage.getItem('kronos_notifications') !== 'false';
        let todasOSAnteriores = [];
        
        // ‚úÖ WEBSOCKET PARA TEMPO REAL (PRESERVADO)
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let pollingInterval = null;

        // ‚úÖ INICIALIZAR BANCO DE DADOS (PRESERVADO)
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                
                request.onerror = () => {
                    console.error('‚ùå Erro ao abrir banco de dados');
                    reject(new Error('Falha ao abrir banco de dados'));
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ Banco de dados inicializado');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Criar object store para OS
                    if (!database.objectStoreNames.contains('os')) {
                        const osStore = database.createObjectStore('os', { keyPath: 'id' });
                        osStore.createIndex('status', 'status', { unique: false });
                        osStore.createIndex('setor_destino', 'setor_destino', { unique: false });
                        osStore.createIndex('data_abertura', 'data_abertura', { unique: false });
                        osStore.createIndex('prioridade', 'prioridade', { unique: false });
                    }
                    
                    // Criar object store para usu√°rio
                    if (!database.objectStoreNames.contains('user')) {
                        const userStore = database.createObjectStore('user', { keyPath: 'id' });
                        userStore.createIndex('email', 'email', { unique: true });
                    }
                    
                    // Criar object store para configura√ß√µes
                    if (!database.objectStoreNames.contains('config')) {
                        const configStore = database.createObjectStore('config', { keyPath: 'key' });
                    }
                };
            });
        }

        // ‚úÖ FUN√á√ïES DO BANCO DE DADOS (PRESERVADAS)
        function salvarOSNoBanco(os) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados n√£o inicializado'));
                    return;
                }
                
                const transaction = db.transaction(['os'], 'readwrite');
                const store = transaction.objectStore('os');
                const request = store.put(os);
                
                request.onsuccess = () => {
                    console.log(`‚úÖ OS #${os.id} salva no banco local`);
                    resolve();
                };
                
                request.onerror = () => {
                    console.error(`‚ùå Erro ao salvar OS #${os.id} no banco local`);
                    reject(new Error('Falha ao salvar OS'));
                };
            });
        }

        function obterOSDoBanco() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados n√£o inicializado'));
                    return;
                }
                
                const transaction = db.transaction(['os'], 'readonly');
                const store = transaction.objectStore('os');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    console.log(`‚úÖ ${request.result.length} OS recuperadas do banco local`);
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error('‚ùå Erro ao recuperar OS do banco local');
                    reject(new Error('Falha ao recuperar OS'));
                };
            });
        }

        function salvarUsuarioNoBanco(usuario) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados n√£o inicializado'));
                    return;
                }
                
                const transaction = db.transaction(['user'], 'readwrite');
                const store = transaction.objectStore('user');
                const request = store.put(usuario);
                
                request.onsuccess = () => {
                    console.log('‚úÖ Usu√°rio salvo no banco local');
                    resolve();
                };
                
                request.onerror = () => {
                    console.error('‚ùå Erro ao salvar usu√°rio no banco local');
                    reject(new Error('Falha ao salvar usu√°rio'));
                };
            });
        }

        function obterUsuarioDoBanco() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados n√£o inicializado'));
                    return;
                }
                
                const transaction = db.transaction(['user'], 'readonly');
                const store = transaction.objectStore('user');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const usuarios = request.result;
                    if (usuarios.length > 0) {
                        resolve(usuarios[0]);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => {
                    reject(new Error('Falha ao recuperar usu√°rio'));
                };
            });
        }

        // ‚úÖ SISTEMA DE √ÅUDIO MODERNO - CORRIGIDO PARA MOBILE
        class SistemaAudioModerno {
            constructor() {
                this.context = null;
                this.unlocked = false;
                this.enabled = audioEnabled;
                this.initialized = false;
                this.isMobile = isMobile;
            }

            // ‚úÖ INICIALIZAR SISTEMA DE √ÅUDIO - CORRIGIDO PARA MOBILE
            async inicializar() {
                if (this.initialized) return true;

                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) {
                        console.warn('‚ùå Web Audio API n√£o suportada');
                        return false;
                    }

                    this.context = new AudioContext();
                    
                    // ‚úÖ ESTRAT√âGIA MELHOR PARA MOBILE - Aguardar intera√ß√£o
                    if (this.isMobile) {
                        console.log('üì± Modo mobile detectado - √Åudio aguardando intera√ß√£o');
                        // No mobile, precisamos esperar intera√ß√£o do usu√°rio
                        this.context.suspend();
                    }

                    this.initialized = true;
                    console.log('‚úÖ Sistema de √°udio moderno inicializado');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao inicializar √°udio:', error);
                    return false;
                }
            }

            // ‚úÖ DESTRAVAR √ÅUDIO INTERATIVAMENTE - CORRIGIDO PARA MOBILE
            async destravar() {
                if (!this.context) return false;

                try {
                    // ‚úÖ ESTRAT√âGIA SIMPLES E EFETIVA PARA MOBILE
                    await this.context.resume();
                    
                    // Tocar um som simples para destravar
                    await this.tocarSomTeste();
                    
                    this.unlocked = true;
                    console.log('üîä √Åudio destravado com sucesso');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao destravar √°udio:', error);
                    return false;
                }
            }

            // ‚úÖ TOCAR SOM DE TESTE SIMPLES - CORRIGIDO
            async tocarSomTeste() {
                if (!this.context || !this.enabled) return;

                try {
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = 440;
                    gainNode.gain.value = 0.001; // Volume muito baixo para teste
                    
                    oscillator.start();
                    oscillator.stop(this.context.currentTime + 0.1);
                    
                } catch (error) {
                    console.log('‚ö†Ô∏è Som de teste n√£o p√¥de ser reproduzido');
                }
            }

            // ‚úÖ VERIFICAR SE PODE TOCAR SOM - CORRIGIDO PARA MOBILE
            podeTocar() {
                return this.context && this.enabled && this.unlocked && this.initialized;
            }

            // ‚úÖ SOM MODERNO PARA NOTIFICA√á√ÉO DE NOVA OS (CR√çTICA/ALTA) - PRESERVADO
            tocarSomNovaOSCritica() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator1 = this.context.createOscillator();
                    const oscillator2 = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator1.type = 'sine';
                    oscillator2.type = 'square';
                    
                    oscillator1.frequency.setValueAtTime(800, now);
                    oscillator1.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    oscillator1.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                    
                    oscillator2.frequency.setValueAtTime(400, now);
                    oscillator2.frequency.exponentialRampToValueAtTime(600, now + 0.15);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.8, now + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.6, now + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0.8, now + 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.3, now + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0.8, now + 0.25);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);

                    oscillator1.start(now);
                    oscillator2.start(now);
                    oscillator1.stop(now + 0.4);
                    oscillator2.stop(now + 0.4);

                    console.log('üîä SOM MODERNO - Nova OS cr√≠tica/alta');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de nova OS:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA NOTIFICA√á√ÉO DE NOVA OS (M√âDIA) - PRESERVADO
            tocarSomNovaOSMedia() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator.type = 'sine';
                    
                    oscillator.frequency.setValueAtTime(600, now);
                    oscillator.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                    oscillator.frequency.exponentialRampToValueAtTime(600, now + 0.4);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

                    oscillator.start(now);
                    oscillator.stop(now + 0.5);

                    console.log('üîä SOM MODERADO - Nova OS m√©dia');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de OS m√©dia:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA NOTIFICA√á√ÉO DE NOVA OS (BAIXA) - PRESERVADO
            tocarSomNovaOSBaixa() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator.type = 'triangle';
                    
                    oscillator.frequency.setValueAtTime(400, now);
                    oscillator.frequency.exponentialRampToValueAtTime(500, now + 0.3);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);

                    oscillator.start(now);
                    oscillator.stop(now + 0.4);

                    console.log('üîä SOM SUAVE - Nova OS baixa');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de OS baixa:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA INICIAR ATENDIMENTO - PRESERVADO
            tocarSomInicioAtendimento() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator1 = this.context.createOscillator();
                    const oscillator2 = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator1.type = 'sine';
                    oscillator2.type = 'triangle';
                    
                    oscillator1.frequency.setValueAtTime(300, now);
                    oscillator1.frequency.exponentialRampToValueAtTime(800, now + 0.3);
                    
                    oscillator2.frequency.setValueAtTime(200, now);
                    oscillator2.frequency.exponentialRampToValueAtTime(500, now + 0.25);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.7, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.4, now + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0.7, now + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

                    oscillator1.start(now);
                    oscillator2.start(now);
                    oscillator1.stop(now + 0.5);
                    oscillator2.stop(now + 0.5);

                    console.log('üîä SOM MODERNO - In√≠cio de atendimento');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de in√≠cio:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA FINALIZAR ATENDIMENTO - PRESERVADO
            tocarSomFinalizacao() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator1 = this.context.createOscillator();
                    const oscillator2 = this.context.createOscillator();
                    const oscillator3 = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    oscillator3.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator1.type = 'sine';
                    oscillator2.type = 'sine';
                    oscillator3.type = 'sine';
                    
                    oscillator1.frequency.setValueAtTime(523.25, now);
                    oscillator2.frequency.setValueAtTime(659.25, now);
                    oscillator3.frequency.setValueAtTime(783.99, now);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.6, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.4, now + 0.3);
                    gainNode.gain.linearRampToValueAtTime(0.6, now + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.8);

                    oscillator1.start(now);
                    oscillator2.start(now);
                    oscillator3.start(now);
                    oscillator1.stop(now + 0.8);
                    oscillator2.stop(now + 0.8);
                    oscillator3.stop(now + 0.8);

                    console.log('üîä SOM MODERNO - Finaliza√ß√£o com sucesso');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de finaliza√ß√£o:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA AGUARDANDO PE√áAS - PRESERVADO
            tocarSomAguardandoPecas() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator.type = 'sine';
                    
                    oscillator.frequency.setValueAtTime(600, now);
                    oscillator.frequency.exponentialRampToValueAtTime(300, now + 0.4);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.7);

                    oscillator.start(now);
                    oscillator.stop(now + 0.7);

                    console.log('üîä SOM MODERNO - Aguardando pe√ßas');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de aguardando:', error);
                }
            }

            // ‚úÖ SOM MODERNO PARA RETOMAR ATENDIMENTO - PRESERVADO
            tocarSomRetomada() {
                if (!this.podeTocar()) return;

                try {
                    const now = this.context.currentTime;
                    const oscillator1 = this.context.createOscillator();
                    const oscillator2 = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    gainNode.connect(this.context.destination);

                    oscillator1.type = 'sine';
                    oscillator2.type = 'square';
                    
                    oscillator1.frequency.setValueAtTime(400, now);
                    oscillator1.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                    
                    oscillator2.frequency.setValueAtTime(300, now);
                    oscillator2.frequency.exponentialRampToValueAtTime(600, now + 0.15);
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.7, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                    oscillator1.start(now);
                    oscillator2.start(now);
                    oscillator1.stop(now + 0.3);
                    oscillator2.stop(now + 0.3);

                    console.log('üîä SOM MODERNO - Retomada de atendimento');

                } catch (error) {
                    console.error('‚ùå Erro ao tocar som de retomada:', error);
                }
            }

            // ‚úÖ TESTE DE SOM COMPLETO - PRESERVADO
            tocarTesteCompleto() {
                if (!this.podeTocar()) return;

                this.tocarSomNovaOSCritica();
                
                setTimeout(() => {
                    this.tocarSomNovaOSMedia();
                }, 600);
                
                setTimeout(() => {
                    this.tocarSomNovaOSBaixa();
                }, 1200);
                
                setTimeout(() => {
                    this.tocarSomInicioAtendimento();
                }, 1800);
                
                setTimeout(() => {
                    this.tocarSomAguardandoPecas();
                }, 2400);
                
                setTimeout(() => {
                    this.tocarSomRetomada();
                }, 3000);
                
                setTimeout(() => {
                    this.tocarSomFinalizacao();
                }, 3600);
            }

            // ‚úÖ ALTERNAR ESTADO DO SOM - PRESERVADO
            alternar() {
                this.enabled = !this.enabled;
                audioEnabled = this.enabled;
                localStorage.setItem('kronos_audio', this.enabled.toString());
                return this.enabled;
            }
        }

        // ‚úÖ INST√ÇNCIA GLOBAL DO SISTEMA DE √ÅUDIO MODERNO
        const sistemaAudio = new SistemaAudioModerno();

        // ‚úÖ CORRE√á√ÉO CR√çTICA: INICIALIZA√á√ÉO DE √ÅUDIO PARA MOBILE
        function inicializarAudioMobile() {
            if (!isMobile) return;
            
            // No mobile, mostramos o modal de destravamento imediatamente
            setTimeout(() => {
                if (audioEnabled && !sistemaAudio.unlocked) {
                    mostrarModalAudio();
                }
            }, 1000);
        }

        // ‚úÖ FUN√á√ïES DE FILTRO E ORGANIZA√á√ÉO (PRESERVADAS)
        function aplicarFiltros() {
            filtroAtual.periodo = document.getElementById('filtroPeriodo').value;
            filtroAtual.ordenacao = document.getElementById('filtroOrdenacao').value;
            filtroAtual.pesquisa = document.getElementById('filtroPesquisa').value.toLowerCase();
            
            osFiltradas = todasOS.filter(os => {
                if (filtroAtual.status !== 'todos') {
                    const statusMap = {
                        'aberto': 'Aberto',
                        'andamento': 'Em Andamento', 
                        'aguardando': 'Aguardando Pe√ßas',
                        'finalizado': 'Finalizado',
                        'cancelado': 'Cancelado'
                    };
                    if (os.status !== statusMap[filtroAtual.status]) {
                        return false;
                    }
                }
                
                if (filtroAtual.periodo !== 'todos') {
                    const dataOS = new Date(os.data_abertura);
                    const hoje = new Date();
                    const diffTime = hoje - dataOS;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    switch(filtroAtual.periodo) {
                        case 'hoje':
                            if (diffDays > 1) return false;
                            break;
                        case 'ontem':
                            if (diffDays !== 1) return false;
                            break;
                        case '7dias':
                            if (diffDays > 7) return false;
                            break;
                        case '15dias':
                            if (diffDays > 15) return false;
                            break;
                        case '30dias':
                            if (diffDays > 30) return false;
                            break;
                    }
                }
                
                if (filtroAtual.prioridade !== 'todas') {
                    const prioridadeMap = {
                        'critica': 'Cr√≠tica',
                        'alta': 'Alta',
                        'media': 'M√©dia',
                        'baixa': 'Baixa'
                    };
                    if (os.prioridade !== prioridadeMap[filtroAtual.prioridade]) {
                        return false;
                    }
                }
                
                if (filtroAtual.pesquisa) {
                    const termo = filtroAtual.pesquisa;
                    return (
                        os.id.toString().includes(termo) ||
                        os.cliente.toLowerCase().includes(termo) ||
                        os.descricao.toLowerCase().includes(termo) ||
                        os.setor_origem.toLowerCase().includes(termo)
                    );
                }
                
                return true;
            });
            
            ordenarOS();
            osVisiveis = 10;
            exibirOSFiltradas();
        }

        function ordenarOS() {
            switch(filtroAtual.ordenacao) {
                case 'data_recente':
                    osFiltradas.sort((a, b) => new Date(b.data_abertura) - new Date(a.data_abertura));
                    break;
                case 'data_antiga':
                    osFiltradas.sort((a, b) => new Date(a.data_abertura) - new Date(b.data_abertura));
                    break;
                case 'prioridade':
                    const prioridadeOrder = { 'Cr√≠tica': 4, 'Alta': 3, 'M√©dia': 2, 'Baixa': 1 };
                    osFiltradas.sort((a, b) => prioridadeOrder[b.prioridade] - prioridadeOrder[a.prioridade]);
                    break;
                case 'numero':
                    osFiltradas.sort((a, b) => b.id - a.id);
                    break;
            }
        }

        function filtrarPorStatus(status) {
            filtroAtual.status = status;
            
            document.querySelectorAll('.status-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            
            if (status === 'todos') {
                document.querySelector('[onclick="mudarAba(\'todos\')"]').classList.add('active');
                document.querySelector('.stat-card:first-child').classList.add('active');
            } else {
                document.querySelector(`[onclick="mudarAba('${status}')"]`).classList.add('active');
                document.querySelector(`.stat-card:nth-child(${getStatCardIndex(status)})`).classList.add('active');
            }
            
            aplicarFiltros();
        }

        function filtrarPorPrioridade(prioridade) {
            filtroAtual.prioridade = prioridade;
            
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="filtrarPorPrioridade('${prioridade}')"]`).classList.add('active');
            
            aplicarFiltros();
        }

        function mudarAba(status) {
            filtrarPorStatus(status);
            
            const titulos = {
                'todos': 'Todas as Ordens de Servi√ßo',
                'aberto': 'Ordens de Servi√ßo em Aberto',
                'andamento': 'Ordens de Servi√ßo em Andamento', 
                'aguardando': 'Ordens Aguardando Pe√ßas',
                'finalizado': 'Ordens de Servi√ßo Finalizadas',
                'cancelado': 'Ordens de Servi√ßo Canceladas'
            };
            
            document.getElementById('sectionTitle').innerHTML = 
                `<i class="fas ${getAbaIcon(status)}"></i> ${titulos[status]}`;
        }

        function getAbaIcon(status) {
            const icons = {
                'todos': 'fa-layer-group',
                'aberto': 'fa-clock',
                'andamento': 'fa-play-circle',
                'aguardando': 'fa-pause-circle',
                'finalizado': 'fa-check-circle',
                'cancelado': 'fa-times-circle'
            };
            return icons[status];
        }

        function getStatCardIndex(status) {
            const indices = {
                'aberto': 2,
                'andamento': 3,
                'aguardando': 4,
                'finalizado': 5,
                'cancelado': 6
            };
            return indices[status] || 1;
        }

        function limparFiltros() {
            document.getElementById('filtroPeriodo').value = 'todos';
            document.getElementById('filtroOrdenacao').value = 'data_recente';
            document.getElementById('filtroPesquisa').value = '';
            
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="filtrarPorPrioridade(\'todas\')"]').classList.add('active');
            
            filtroAtual = {
                status: 'todos',
                periodo: 'todos',
                ordenacao: 'data_recente',
                pesquisa: '',
                prioridade: 'todas'
            };
            
            aplicarFiltros();
            mudarAba('todos');
        }

        // ‚úÖ FUN√á√ÉO PARA EXIBIR OS FILTRADAS (PRESERVADA)
        function exibirOSFiltradas() {
            const osParaExibir = osFiltradas.slice(0, osVisiveis);
            
            document.getElementById('count-exibidas').textContent = `${osParaExibir.length} de ${osFiltradas.length}`;
            
            exibirListaOS('listaOS', osParaExibir, 'todas');
            
            const verMaisContainer = document.getElementById('verMaisContainer');
            if (osFiltradas.length > osVisiveis) {
                verMaisContainer.style.display = 'block';
                document.getElementById('btnVerMais').innerHTML = 
                    `<i class="fas fa-chevron-down"></i> Ver Mais (${osFiltradas.length - osVisiveis} restantes)`;
            } else {
                verMaisContainer.style.display = 'none';
            }
        }

        function carregarMaisOS() {
            osVisiveis += 10;
            exibirOSFiltradas();
        }

        // ‚úÖ ATUALIZAR CONTADORES NAS ABAS (PRESERVADA)
        function atualizarContadoresAbas() {
            const contadores = {
                'todos': todasOS.length,
                'aberto': todasOS.filter(os => os.status === 'Aberto').length,
                'andamento': todasOS.filter(os => os.status === 'Em Andamento').length,
                'aguardando': todasOS.filter(os => os.status === 'Aguardando Pe√ßas').length,
                'finalizado': todasOS.filter(os => os.status === 'Finalizado').length,
                'cancelado': todasOS.filter(os => os.status === 'Cancelado').length
            };
            
            Object.keys(contadores).forEach(status => {
                const badge = document.getElementById(`badge-${status}`);
                if (badge) {
                    badge.textContent = contadores[status];
                }
            });
        }

        // ‚úÖ VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ATUALIZADA (PRESERVADA)
        function verificarAutenticacao() {
            const user = localStorage.getItem('kronos_user');
            const token = localStorage.getItem('kronos_token');
            const setorSelecionado = localStorage.getItem('tecnico_setor_selecionado');
            
            if (!user || !token) {
                showToast('Acesso n√£o autorizado', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return false;
            }
            
            try {
                const userData = JSON.parse(user);
                if (!setorSelecionado) {
                    showToast('Selecione um setor para atender', 'warning');
                    setTimeout(() => window.location.href = 'tecnico-selecao-setor.html', 2000);
                    return false;
                }
                
                userSetor = setorSelecionado;
                document.getElementById('userInfo').textContent = `${userData.nome} - ${setorSelecionado}`;
                document.getElementById('welcomeMessage').textContent = `Bem-vindo, ${userData.nome}! - Setor: ${setorSelecionado}`;
                
                salvarUsuarioNoBanco(userData).catch(console.error);
                
                return true;
            } catch (e) {
                console.error('Erro:', e);
                window.location.href = 'index.html';
                return false;
            }
        }

        // ‚úÖ FUN√á√ÉO CARREGAR OS ATUALIZADA COM BANCO LOCAL (PRESERVADA)
        async function carregarOSsSetor() {
            try {
                mostrarLoading(true);
                const token = localStorage.getItem('kronos_token');
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);

                    const response = await fetch(`${API_BASE_URL}/api/os/setor/${userSetor}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();
                        let osList = [];
                        
                        if (data.success && data.data) {
                            osList = data.data;
                        } else if (Array.isArray(data)) {
                            osList = data;
                        }
                        
                        await Promise.all(osList.map(os => salvarOSNoBanco(os)));
                        
                        todasOS = osList;
                        console.log(`‚úÖ ${osList.length} OS carregadas do servidor`);
                    } else {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar do servidor, usando banco local:', error);
                    
                    try {
                        const osLocal = await obterOSDoBanco();
                        todasOS = osLocal.filter(os => os.setor_destino === userSetor);
                        console.log(`‚úÖ ${todasOS.length} OS carregadas do banco local`);
                        
                        showToast('Modo offline - Dados carregados do cache', 'warning');
                    } catch (localError) {
                        console.error('‚ùå Erro ao carregar do banco local:', localError);
                        todasOS = [];
                    }
                }
                
                verificarNovasOS(todasOS);
                atualizarEstatisticas(todasOS);
                atualizarContadoresAbas();
                aplicarFiltros();
                atualizarContadorNovasOS();
                mostrarLoading(false);
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico:', error);
                mostrarError(true, `Erro ao carregar OS: ${error.message}`);
            }
        }

        // ‚úÖ ATUALIZAR OS NO BANCO LOCAL (PRESERVADA)
        async function atualizarOSNoBanco(osAtualizada) {
            try {
                await salvarOSNoBanco(osAtualizada);
                console.log(`‚úÖ OS #${osAtualizada.id} atualizada no banco local`);
            } catch (error) {
                console.error(`‚ùå Erro ao atualizar OS #${osAtualizada.id} no banco local:`, error);
            }
        }

        // ‚úÖ MODIFICA√á√ÉO DA FUN√á√ÉO atualizarEstatisticas (PRESERVADA)
        function atualizarEstatisticas(osList) {
            const total = osList.length;
            const abertas = osList.filter(os => os.status === 'Aberto').length;
            const andamento = osList.filter(os => os.status === 'Em Andamento').length;
            const aguardando = osList.filter(os => os.status === 'Aguardando Pe√ßas').length;
            const finalizadas = osList.filter(os => os.status === 'Finalizado').length;
            const canceladas = osList.filter(os => os.status === 'Cancelado').length;

            document.getElementById('total-os').textContent = total;
            document.getElementById('os-abertas').textContent = abertas;
            document.getElementById('os-andamento').textContent = andamento;
            document.getElementById('os-aguardando').textContent = aguardando;
            document.getElementById('os-finalizadas').textContent = finalizadas;
            document.getElementById('os-canceladas').textContent = canceladas;
        }

        // ‚úÖ GERENCIAMENTO DE ESTADOS (PRESERVADO)
        function mostrarLoading(mostrar) {
            document.getElementById('loadingState').style.display = mostrar ? 'block' : 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('contentArea').style.display = mostrar ? 'none' : 'block';
        }

        function mostrarError(mostrar, mensagem) {
            document.getElementById('errorState').style.display = mostrar ? 'block' : 'none';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentArea').style.display = mostrar ? 'none' : 'block';
            if (mensagem) {
                document.getElementById('errorMessage').textContent = mensagem;
            }
        }

        // ‚úÖ VERIFICAR NOVAS OS (PRESERVADA)
        function verificarNovasOS(osAtuais) {
            if (todasOSAnteriores.length === 0) {
                todasOSAnteriores = osAtuais;
                return;
            }

            const novasOS = osAtuais.filter(osAtual => 
                !todasOSAnteriores.some(osAnterior => osAnterior.id === osAtual.id)
            );

            if (novasOS.length > 0 && notificationEnabled && sistemaAudio.podeTocar()) {
                novasOS.forEach(os => {
                    if (os.status === 'Aberto') {
                        switch(os.prioridade) {
                            case 'Cr√≠tica':
                            case 'Alta':
                                sistemaAudio.tocarSomNovaOSCritica();
                                showToast(
                                    `üö® NOVA OS ${os.prioridade} #${os.id} - ${os.setor_origem}`,
                                    'urgent',
                                    6000
                                );
                                break;
                            case 'M√©dia':
                                sistemaAudio.tocarSomNovaOSMedia();
                                showToast(
                                    `üìã Nova OS M√©dia #${os.id} - ${os.setor_origem}`,
                                    'info',
                                    5000
                                );
                                break;
                            case 'Baixa':
                                sistemaAudio.tocarSomNovaOSBaixa();
                                showToast(
                                    `üìÑ Nova OS Baixa #${os.id} - ${os.setor_origem}`,
                                    'success',
                                    4000
                                );
                                break;
                        }
                    }
                });
            }

            todasOSAnteriores = osAtuais;
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Obter classe CSS para prioridade (PRESERVADA)
        function getPrioridadeClass(prioridade) {
            const classes = {
                'Baixa': 'prioridade-baixa',
                'M√©dia': 'prioridade-media', 
                'Alta': 'prioridade-alta',
                'Cr√≠tica': 'prioridade-critica'
            };
            return classes[prioridade] || 'prioridade-media';
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Obter √≠cone para prioridade (PRESERVADA)
        function getPrioridadeIcon(prioridade) {
            const icons = {
                'Baixa': 'üü¢',
                'M√©dia': 'üü°',
                'Alta': 'üü†', 
                'Cr√≠tica': 'üî¥'
            };
            return icons[prioridade] || '‚ö™';
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Obter √≠cone para status (PRESERVADA)
        function getStatusIcon(status) {
            const icons = {
                'Aberto': 'üü¢',
                'Em Andamento': 'üü°',
                'Aguardando Pe√ßas': 'üü£',
                'Finalizado': '‚úÖ',
                'Cancelado': '‚ùå'
            };
            return icons[status] || 'üìÑ';
        }

        function exibirListaOS(elementId, ordens, tipo) {
            const lista = document.getElementById(elementId);
            
            if (ordens.length === 0) {
                let mensagem = '';
                let icone = '';
                if (tipo === 'pendentes') {
                    mensagem = 'Nenhuma OS pendente';
                    icone = 'fa-clock';
                } else {
                    mensagem = 'Nenhuma OS atendida';
                    icone = 'fa-check-circle';
                }
                
                lista.innerHTML = `
                    <div class="empty-state">
                        <i class="fas ${icone}"></i>
                        <h4>${mensagem}</h4>
                        <p>${tipo === 'pendentes' ? 'Todas as OS est√£o finalizadas!' : 'Suas OS finalizadas aparecer√£o aqui'}</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = ordens.map(os => {
                const statusClass = `status-${os.status.toLowerCase().replace(/ /g, '')}`;
                const prioridadeClass = getPrioridadeClass(os.prioridade);
                const prioridadeIcon = getPrioridadeIcon(os.prioridade);
                const dataAbertura = new Date(os.data_abertura).toLocaleDateString('pt-BR');
                const horaAbertura = new Date(os.data_abertura).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="os-item" data-os-id="${os.id}">
                        <div class="os-header">
                            <div class="os-info">
                                <h4>OS #${os.id} - ${os.setor_origem}</h4>
                                <div class="os-meta">
                                    ${os.cliente} ‚Ä¢ ${dataAbertura} √†s ${horaAbertura}
                                    <span class="prioridade-badge ${prioridadeClass}">
                                        ${prioridadeIcon} ${os.prioridade}
                                    </span>
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">
                                ${getStatusIcon(os.status)} ${os.status}
                            </span>
                        </div>
                        
                        <div class="os-details">
                            <p><strong><i class="fas fa-tag"></i> Categoria:</strong> ${os.categoria}</p>
                            <p><strong><i class="fas fa-cogs"></i> Setor Destino:</strong> ${os.setor_destino}</p>
                            <p><strong><i class="fas fa-file-alt"></i> Descri√ß√£o:</strong> ${os.descricao}</p>
                            
                            ${os.relato_tecnico ? `
                                <div style="background: rgba(79, 195, 247, 0.1); padding: 1rem; border-radius: 10px; margin-top: 1rem; border: 1px solid rgba(79, 195, 247, 0.2);">
                                    <strong><i class="fas fa-clipboard-check"></i> Relat√≥rio T√©cnico:</strong> ${os.relato_tecnico}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="os-actions">
                            ${os.status === 'Aberto' ? `
                                <button class="btn-action btn-andamento" onclick="iniciarAtendimento(${os.id})" id="btn-iniciar-${os.id}">
                                    <i class="fas fa-play-circle"></i> Iniciar Atendimento
                                </button>
                            ` : ''}
                            
                            ${os.status === 'Em Andamento' ? `
                                <button class="btn-action btn-aguardando" onclick="marcarAguardandoPecas(${os.id})">
                                    <i class="fas fa-clock"></i> Aguardando Pe√ßas
                                </button>
                                <button class="btn-action btn-finalizar" onclick="abrirModal(${os.id}, 'Finalizado')">
                                    <i class="fas fa-check-circle"></i> Finalizar
                                </button>
                            ` : ''}
                            
                            ${os.status === 'Aguardando Pe√ßas' ? `
                                <button class="btn-action btn-andamento" onclick="retomarAtendimento(${os.id})">
                                    <i class="fas fa-play-circle"></i> Retomar Atendimento
                                </button>
                                <button class="btn-action btn-finalizar" onclick="abrirModal(${os.id}, 'Finalizado')">
                                    <i class="fas fa-check-circle"></i> Finalizar
                                </button>
                            ` : ''}
                            
                            ${os.status !== 'Finalizado' && os.status !== 'Cancelado' ? `
                                <button class="btn-action btn-cancelar" onclick="abrirModal(${os.id}, 'Cancelado')">
                                    <i class="fas fa-times-circle"></i> Cancelar
                                </button>
                            ` : ''}
                            
                            <button class="btn-action btn-detalhes" onclick="abrirModal(${os.id}, '${os.status}')">
                                <i class="fas fa-edit"></i> Atualizar/Reclassificar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚úÖ BOT√ÉO INICIAR ATENDIMENTO COM SOM MODERNO (PRESERVADO)
        async function iniciarAtendimento(osId) {
            const button = document.getElementById(`btn-iniciar-${osId}`);
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
                button.classList.add('btn-loading');
                button.disabled = true;

                const token = localStorage.getItem('kronos_token');
                const user = JSON.parse(localStorage.getItem('kronos_user'));
                
                const response = await fetch(`${API_BASE_URL}/api/os/${osId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'Em Andamento',
                        relato_tecnico: `Atendimento iniciado por ${user.nome} em ${new Date().toLocaleString('pt-BR')}`,
                        tecnico_id: user.id,
                        tecnico_nome: user.nome
                    })
                });

                if (response.ok) {
                    if (sistemaAudio.podeTocar()) {
                        sistemaAudio.tocarSomInicioAtendimento();
                    }
                    
                    showToast(`üéØ Atendimento da OS #${osId} iniciado!`, 'success');
                    setTimeout(() => carregarOSsSetor(), 300);
                } else {
                    throw new Error('Erro ao iniciar atendimento');
                }

            } catch (error) {
                console.error('‚ùå Erro ao iniciar atendimento:', error);
                showToast(`Erro ao iniciar atendimento: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: MARCAR COMO AGUARDANDO PE√áAS COM SOM MODERNO (PRESERVADO)
        async function marcarAguardandoPecas(osId) {
            const button = document.querySelector(`[onclick="marcarAguardandoPecas(${osId})"]`);
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
                button.classList.add('btn-loading');
                button.disabled = true;

                const token = localStorage.getItem('kronos_token');
                const user = JSON.parse(localStorage.getItem('kronos_user'));
                
                const response = await fetch(`${API_BASE_URL}/api/os/${osId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'Aguardando Pe√ßas',
                        relato_tecnico: `OS colocada em espera por falta de pe√ßas - ${user.nome} em ${new Date().toLocaleString('pt-BR')}`
                    })
                });

                if (response.ok) {
                    if (sistemaAudio.podeTocar()) {
                        sistemaAudio.tocarSomAguardandoPecas();
                    }
                    
                    showToast(`‚è≥ OS #${osId} marcada como Aguardando Pe√ßas!`, 'info');
                    setTimeout(() => carregarOSsSetor(), 300);
                } else {
                    throw new Error('Erro ao atualizar status');
                }

            } catch (error) {
                console.error('‚ùå Erro ao marcar como aguardando pe√ßas:', error);
                showToast(`Erro: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: RETOMAR ATENDIMENTO COM SOM MODERNO (PRESERVADO)
        async function retomarAtendimento(osId) {
            const button = document.querySelector(`[onclick="retomarAtendimento(${osId})"]`);
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retomando...';
                button.classList.add('btn-loading');
                button.disabled = true;

                const token = localStorage.getItem('kronos_token');
                const user = JSON.parse(localStorage.getItem('kronos_user'));
                
                const response = await fetch(`${API_BASE_URL}/api/os/${osId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'Em Andamento',
                        relato_tecnico: `OS retomada - pe√ßas recebidas - ${user.nome} em ${new Date().toLocaleString('pt-BR')}`
                    })
                });

                if (response.ok) {
                    if (sistemaAudio.podeTocar()) {
                        sistemaAudio.tocarSomRetomada();
                    }
                    
                    showToast(`üéØ OS #${osId} retomada!`, 'success');
                    setTimeout(() => carregarOSsSetor(), 300);
                } else {
                    throw new Error('Erro ao retomar atendimento');
                }

            } catch (error) {
                console.error('‚ùå Erro ao retomar atendimento:', error);
                showToast(`Erro: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // ‚úÖ MODAL DE ATUALIZA√á√ÉO (PRESERVADO)
        function abrirModal(osId, status) {
            const os = todasOS.find(os => os.id == osId);
            
            if (os) {
                document.getElementById('osId').value = osId;
                document.getElementById('osStatus').value = status;
                document.getElementById('osPrioridade').value = '';
                document.getElementById('osRelato').value = os.relato_tecnico || '';
                document.getElementById('osMateriais').value = os.materiais_usados || '';
                
                const prioridadeSelect = document.getElementById('osPrioridade');
                prioridadeSelect.querySelector('option[value=""]').textContent = 
                    `Manter: ${os.prioridade || 'N√£o definida'}`;
                
                document.getElementById('modalAtualizarOS').style.display = 'block';
            } else {
                showToast('OS n√£o encontrada', 'error');
            }
        }

        function fecharModal() {
            document.getElementById('modalAtualizarOS').style.display = 'none';
            document.getElementById('formAtualizarOS').reset();
        }

        // ‚úÖ ATUALIZA√á√ÉO COMPLETA DA OS COM SOM MODERNO E BANCO LOCAL (PRESERVADO)
        document.getElementById('formAtualizarOS').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const osId = document.getElementById('osId').value;
            const status = document.getElementById('osStatus').value;
            const novaPrioridade = document.getElementById('osPrioridade').value;
            const relato = document.getElementById('osRelato').value;
            const materiais = document.getElementById('osMateriais').value;
            const token = localStorage.getItem('kronos_token');
            const button = document.getElementById('btnSubmitModal');

            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
            button.disabled = true;

            try {
                const updateData = {
                    status: status,
                    relato_tecnico: relato || null,
                    materiais_usados: materiais || null
                };

                if (novaPrioridade) {
                    updateData.prioridade = novaPrioridade;
                }

                const response = await fetch(`${API_BASE_URL}/api/os/${osId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const osAtualizada = await response.json();
                    
                    if (status === 'Finalizado' && sistemaAudio.podeTocar()) {
                        sistemaAudio.tocarSomFinalizacao();
                    }
                    
                    await atualizarOSNoBanco(osAtualizada);
                    
                    let mensagem = `OS #${osId} atualizada com sucesso!`;
                    if (novaPrioridade) {
                        mensagem += ` Prioridade reclassificada para: ${novaPrioridade}`;
                    }
                    
                    showToast(mensagem, 'success');
                    fecharModal();
                    setTimeout(() => carregarOSsSetor(), 300);
                } else {
                    throw new Error('Erro ao atualizar OS');
                }

            } catch (error) {
                console.error('‚ùå Erro ao atualizar OS:', error);
                showToast(`Erro ao atualizar OS: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // ‚úÖ SISTEMA DE NOTIFICA√á√ïES (PRESERVADO)
        function showToast(message, type = 'success', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${getToastIcon(type)}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 50);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        function getToastIcon(type) {
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-triangle',
                'warning': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'urgent': 'fa-bell'
            };
            return icons[type] || 'fa-info-circle';
        }

        // ‚úÖ INICIALIZAR BOT√ÉO DE NOTIFICA√á√ïES (PRESERVADO)
        function inicializarBotaoNotificacoes() {
            const btn = document.getElementById('btnNotificacoes');
            if (notificationEnabled) {
                btn.innerHTML = '<i class="fas fa-bell"></i> Notifica√ß√µes: ON';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-info');
            } else {
                btn.innerHTML = '<i class="fas fa-bell-slash"></i> Notifica√ß√µes: OFF';
                btn.classList.remove('btn-info');
                btn.classList.add('btn-secondary');
            }
        }

        // ‚úÖ ALTERNAR NOTIFICA√á√ïES (PRESERVADO)
        function alternarNotificacoes() {
            notificationEnabled = !notificationEnabled;
            localStorage.setItem('kronos_notifications', notificationEnabled.toString());
            
            if (notificationEnabled) {
                showToast('üîî Notifica√ß√µes sonoras ATIVADAS', 'success', 3000);
            } else {
                showToast('üîï Notifica√ß√µes sonoras DESATIVADAS', 'warning', 3000);
            }
            
            inicializarBotaoNotificacoes();
            atualizarContadorNovasOS();
        }

        // ‚úÖ ATUALIZAR CONTADOR DE NOVAS OS (PRESERVADO)
        function atualizarContadorNovasOS() {
            const contadorNovas = document.getElementById('contadorNovasOS');
            if (!contadorNovas) return;

            const novasOS = todasOS.filter(os => 
                os.status === 'Aberto' && 
                !todasOSAnteriores.some(osAnt => osAnt.id === os.id)
            );

            if (novasOS.length > 0 && notificationEnabled) {
                contadorNovas.textContent = novasOS.length;
                contadorNovas.style.display = 'inline-block';
            } else {
                contadorNovas.style.display = 'none';
            }
        }

        // ‚úÖ CORRE√á√ÉO CR√çTICA: DESTRAVAR √ÅUDIO INTERATIVAMENTE - CORRIGIDO PARA MOBILE
        async function destravarAudioInterativo() {
            console.log('Destravando √°udio interativamente...');
            
            const resultado = await sistemaAudio.destravar();
            
            if (resultado) {
                mostrarStatusSom('üîä Som ativado com sucesso!', true);
                fecharModalAudio();
                audioUnlocked = true;
                audioTested = true;
                
                // Testar o som ap√≥s destravar
                setTimeout(() => testarSom(), 500);
            } else {
                mostrarStatusSom('‚ùå Erro ao ativar som', false);
            }
            
            atualizarBotoesSom();
        }

        // ‚úÖ MOSTRAR MODAL DE DESTRAVAMENTO - CORRIGIDO
        function mostrarModalAudio() {
            if (!audioEnabled || audioUnlocked) return;
            
            document.getElementById('audioUnlockModal').style.display = 'flex';
        }

        // ‚úÖ FECHAR MODAL DE DESTRAVAMENTO
        function fecharModalAudio() {
            document.getElementById('audioUnlockModal').style.display = 'none';
        }

        // ‚úÖ TESTAR SOM MODERNO - CORRIGIDO
        function testarSom() {
            if (!sistemaAudio.podeTocar()) {
                mostrarModalAudio();
                return;
            }
            
            const btnTest = document.getElementById('btnTestSound');
            btnTest.classList.add('testing');
            
            sistemaAudio.tocarTesteCompleto();
            
            setTimeout(() => {
                btnTest.classList.remove('testing');
                mostrarStatusSom('üîä Teste de som moderno realizado!', true);
            }, 4200);
        }

        // ‚úÖ ALTERNAR SOM - CORRIGIDO
        function alternarSom() {
            const novoEstado = sistemaAudio.alternar();
            
            if (novoEstado) {
                mostrarStatusSom('üîä Som ativado', true);
                setTimeout(() => {
                    if (!sistemaAudio.unlocked && isMobile) {
                        mostrarModalAudio();
                    }
                }, 1000);
            } else {
                mostrarStatusSom('üîá Som desativado', false);
            }
            
            atualizarBotoesSom();
        }

        // ‚úÖ ATUALIZAR BOT√ïES DE SOM - CORRIGIDO
        function atualizarBotoesSom() {
            const btnToggle = document.getElementById('btnToggleSound');
            const btnTest = document.getElementById('btnTestSound');
            const icon = btnToggle.querySelector('i');
            
            if (audioEnabled) {
                btnToggle.classList.add('active');
                icon.className = 'fas fa-volume-up';
                btnTest.disabled = false;
                btnTest.title = 'Testar som moderno';
            } else {
                btnToggle.classList.remove('active');
                icon.className = 'fas fa-volume-mute';
                btnTest.disabled = true;
                btnTest.title = 'Ative o som primeiro';
            }
        }

        // ‚úÖ MOSTRAR STATUS DO SOM - CORRIGIDO
        function mostrarStatusSom(mensagem, sucesso = true) {
            const statusElement = document.getElementById('soundStatus');
            statusElement.textContent = mensagem;
            statusElement.style.display = 'block';
            statusElement.style.color = sucesso ? '#2ecc71' : '#e74c3c';
            statusElement.style.borderColor = sucesso ? 'rgba(46, 204, 113, 0.3)' : 'rgba(231, 76, 60, 0.3)';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // ‚úÖ INICIALIZAR WEBSOCKET (PRESERVADO)
        function inicializarWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/tecnicos`;
                
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function() {
                    console.log('‚úÖ WebSocket conectado');
                    reconnectAttempts = 0;
                    
                    const user = JSON.parse(localStorage.getItem('kronos_user') || '{}');
                    const setor = localStorage.getItem('tecnico_setor_selecionado');
                    
                    socket.send(JSON.stringify({
                        type: 'identify',
                        user: user,
                        setor: setor
                    }));
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'nova_os') {
                        handleNovaOS(data.os);
                    } else if (data.type === 'os_atualizada') {
                        handleOSAtualizada(data.os);
                    } else if (data.type === 'ping') {
                        socket.send(JSON.stringify({ type: 'pong' }));
                    }
                };
                
                socket.onclose = function() {
                    console.log('‚ùå WebSocket desconectado');
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const timeout = Math.min(1000 * reconnectAttempts, 10000);
                        setTimeout(inicializarWebSocket, timeout);
                    } else {
                        usarPollingSuave();
                    }
                };
                
                socket.onerror = function(error) {
                    console.error('‚ùå Erro WebSocket:', error);
                };
                
            } catch (error) {
                console.log('‚ùå WebSocket n√£o suportado, usando polling suave');
                usarPollingSuave();
            }
        }

        // ‚úÖ POLLING SUAVE COMO FALLBACK (PRESERVADO)
        function usarPollingSuave() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(carregarOSsSetor, 30000);
        }

        // ‚úÖ HANDLERS PARA MENSAGENS WEBSOCKET (PRESERVADO)
        function handleNovaOS(os) {
            console.log('üÜï Nova OS recebida via WebSocket:', os);
            
            if (notificationEnabled && sistemaAudio.podeTocar()) {
                switch(os.prioridade) {
                    case 'Cr√≠tica':
                    case 'Alta':
                        sistemaAudio.tocarSomNovaOSCritica();
                        showToast(
                            `üö® NOVA OS ${os.prioridade} #${os.id} - ${os.setor_origem}`,
                            'urgent',
                            6000
                        );
                        break;
                    case 'M√©dia':
                        sistemaAudio.tocarSomNovaOSMedia();
                        showToast(
                            `üìã Nova OS M√©dia #${os.id} - ${os.setor_origem}`,
                            'info',
                            5000
                        );
                        break;
                    case 'Baixa':
                        sistemaAudio.tocarSomNovaOSBaixa();
                        showToast(
                            `üìÑ Nova OS Baixa #${os.id} - ${os.setor_origem}`,
                            'success',
                            4000
                        );
                        break;
                }
            }
            
            carregarOSsSetor();
        }

        function handleOSAtualizada(os) {
            const index = todasOS.findIndex(o => o.id === os.id);
            if (index !== -1) {
                todasOS[index] = os;
                aplicarFiltros();
            }
        }

        // ‚úÖ RESETAR VISUALIZA√á√ÉO (PRESERVADO)
        function resetarVisualizacao() {
            osVisiveis = 10;
            todasOS = [];
            osFiltradas = [];
        }

        // ‚úÖ FUN√á√ïES DE NAVEGA√á√ÉO (PRESERVADAS)
        function trocarSetor() {
            if (confirm('Deseja trocar de setor de atendimento?')) {
                resetarVisualizacao();
                localStorage.removeItem('tecnico_setor_selecionado');
                window.location.href = 'tecnico-selecao-setor.html';
            }
        }

        function logout() {
            if (confirm('Deseja sair?')) {
                localStorage.removeItem('kronos_user');
                localStorage.removeItem('kronos_token');
                localStorage.removeItem('tecnico_setor_selecionado');
                window.location.href = 'index.html';
            }
        }

        // ‚úÖ FUN√á√ÉO PARA SINCRONIZAR DADOS OFFLINE (PRESERVADA)
        async function sincronizarDadosOffline() {
            try {
                const osLocal = await obterOSDoBanco();
                const token = localStorage.getItem('kronos_token');
                
                for (const os of osLocal) {
                    console.log('Sincronizando OS:', os.id);
                }
                
                console.log('‚úÖ Sincroniza√ß√£o offline conclu√≠da');
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o offline:', error);
            }
        }

        // ‚úÖ VERIFICAR CONEX√ÉO E SINCRONIZAR (PRESERVADO)
        window.addEventListener('online', () => {
            showToast('Conex√£o restaurada - Sincronizando dados...', 'success');
            setTimeout(sincronizarDadosOffline, 1000);
        });

        window.addEventListener('offline', () => {
            showToast('Modo offline - Trabalhando com dados locais', 'warning');
        });

        // ‚úÖ INICIALIZA√á√ÉO COMPLETA ATUALIZADA - CORRIGIDA PARA MOBILE
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar banco de dados primeiro
            try {
                await initDatabase();
                console.log('‚úÖ Banco de dados IndexedDB inicializado');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar banco de dados:', error);
                showToast('Erro ao inicializar armazenamento local', 'error');
            }
            
            if (verificarAutenticacao()) {
                // Inicializar sistema de √°udio moderno
                await sistemaAudio.inicializar();
                
                // ‚úÖ CORRE√á√ÉO CR√çTICA: Inicializa√ß√£o espec√≠fica para mobile
                inicializarAudioMobile();
                
                // Configurar controles de som
                atualizarBotoesSom();
                document.getElementById('btnToggleSound').addEventListener('click', alternarSom);
                document.getElementById('btnTestSound').addEventListener('click', testarSom);
                
                // ‚úÖ CORRE√á√ÉO PARA MOBILE - Adicionar event listeners touch
                document.getElementById('btnToggleSound').addEventListener('touchstart', alternarSom, { passive: true });
                document.getElementById('btnTestSound').addEventListener('touchstart', testarSom, { passive: true });
                
                // Inicializar bot√£o de notifica√ß√µes
                inicializarBotaoNotificacoes();
                
                // Inicializar WebSocket
                inicializarWebSocket();
                
                // Carregamento inicial
                carregarOSsSetor();
                
                // ‚úÖ CORRE√á√ÉO: Mostrar modal de destravamento se necess√°rio (apenas mobile)
                if (isMobile && audioEnabled && !sistemaAudio.unlocked) {
                    setTimeout(() => {
                        mostrarModalAudio();
                    }, 2000);
                }
                
                // Mensagem informativa
                if (isMobile) {
                    setTimeout(() => {
                        showToast('üì± Use os filtros para encontrar OS espec√≠ficas rapidamente', 'info', 5000);
                    }, 3000);
                }
            }
        });

        // ‚úÖ CORRE√á√ÉO ADICIONAL PARA MOBILE - GARANTIR QUE OS BOT√ïES FUNCIONEM
        document.addEventListener('touchstart', function(e) {
            if (e.target.closest('.btn-action')) {
                e.preventDefault();
                const button = e.target.closest('.btn-action');
                button.click();
            }
        }, { passive: false });

        // ‚úÖ EVENT LISTENERS PARA MOBILE - CORRIGIDOS
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalAtualizarOS');
            if (event.target === modal) {
                fecharModal();
            }
        });

        // ‚úÖ CORRE√á√ÉO PARA BOT√ïES NO MOBILE
        document.addEventListener('touchstart', function() {
            // Esta fun√ß√£o vazia ajuda a melhorar a responsividade no mobile
        }, { passive: true });
    </script>
</body>
</html>